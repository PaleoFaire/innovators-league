name: Automated Data Pipeline

on:
  schedule:
    # Daily quick update at 7:00 AM UTC (news + market pulse)
    - cron: '0 7 * * *'
    # Weekly deep update every Monday at 8:00 AM UTC
    - cron: '0 8 * * 1'
  workflow_dispatch:
    inputs:
      mode:
        description: 'Update mode'
        required: false
        default: 'standard'
        type: choice
        options:
          - quick
          - standard
          - deep

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install dependencies
        run: pip install -r scripts/requirements.txt

      - name: Determine update mode
        id: mode
        run: |
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            echo "mode=${{ inputs.mode || 'standard' }}" >> $GITHUB_OUTPUT
          elif [ "$(date +%u)" = "1" ]; then
            echo "mode=deep" >> $GITHUB_OUTPUT
          else
            echo "mode=quick" >> $GITHUB_OUTPUT
          fi

      - name: Run data pipeline
        env:
          FMP_API_KEY: ${{ secrets.FMP_API_KEY }}
        run: |
          MODE=${{ steps.mode.outputs.mode }}
          if [ "$MODE" = "quick" ]; then
            python scripts/update_data.py --quick
          elif [ "$MODE" = "deep" ]; then
            python scripts/update_data.py --deep
          else
            python scripts/update_data.py
          fi

      - name: Check for changes
        id: changes
        run: |
          git diff --quiet data.js || echo "changed=true" >> $GITHUB_OUTPUT

      - name: Commit and push updates
        if: steps.changes.outputs.changed == 'true'
        run: |
          git config user.name "Innovators League Bot"
          git config user.email "bot@innovatorsleague.com"
          git add data.js
          git commit -m "chore: automated data update $(date +%Y-%m-%d) [${{ steps.mode.outputs.mode }}]

          Automated pipeline update:
          - Market pulse & stock data refresh
          - News ticker update from RSS feeds
          - Funding round detection
          - LAST_UPDATED timestamp bump

          Mode: ${{ steps.mode.outputs.mode }}"
          git push

      - name: Upload update report
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: update-report-${{ github.run_id }}
          path: update_report.txt
          retention-days: 30
