<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovation Insights | The Innovators League</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg: #000000;
  --bg-s: #0a0a0a;
  --bg-t: #111111;
  --bg-card: #0d0d0d;
  --text: #f0f0fa;
  --text-s: rgba(240,240,250,0.60);
  --text-m: rgba(240,240,250,0.40);
  --border: rgba(255,255,255,0.08);
  --border-hover: rgba(255,255,255,0.15);
  --accent: #FF6B2C;
  --accent-dim: rgba(255,107,44,0.12);
  --radius: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
}

html { scroll-behavior: smooth; }
body { font-family:'Inter',-apple-system,sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }

/* Nav */
.nav { position:fixed; top:0; left:0; right:0; z-index:1000; display:flex; align-items:center; justify-content:space-between; padding:0 32px; height:56px; background:rgba(0,0,0,0.85); backdrop-filter:blur(16px); border-bottom:1px solid var(--border); }
.nav-brand { display:flex; align-items:center; gap:10px; }
.nav-logo { font-family:'Space Grotesk',sans-serif; font-weight:700; font-size:14px; color:#000; background:var(--accent); padding:3px 8px; border-radius:4px; letter-spacing:1px; }
.nav-title { font-family:'Space Grotesk',sans-serif; font-weight:600; font-size:13px; letter-spacing:2px; color:var(--text); }
.nav-links { display:flex; gap:24px; align-items:center; }
.nav-links a { font-size:14px; font-weight:500; color:var(--text-s); text-decoration:none; transition:color .15s; }
.nav-links a:hover { color:var(--text); }
.nav-cta { background:var(--accent)!important; color:#000!important; padding:6px 16px; border-radius:6px; font-weight:600!important; font-size:13px!important; }
.nav-cta:hover { opacity:0.9; }

/* Hero */
.hero { padding:100px 24px 48px; text-align:center; border-bottom:1px solid var(--border); position:relative; }
.hero::before { content:''; position:absolute; top:50%; left:50%; width:600px; height:600px; transform:translate(-50%,-50%); background:radial-gradient(ellipse,rgba(255,107,44,0.04) 0%,transparent 70%); pointer-events:none; }
.hero h1 { font-family:'Space Grotesk',sans-serif; font-size:clamp(32px,4vw,48px); font-weight:800; margin-bottom:8px; letter-spacing:-0.03em; }
.hero p { font-size:17px; color:var(--text-s); max-width:600px; margin:0 auto; }

/* Container */
.container { max-width:1200px; margin:0 auto; padding:0 24px; }

/* Section */
.viz-section { padding:64px 0; border-bottom:1px solid var(--border); }
.viz-section:last-of-type { border-bottom:none; }
.viz-header { margin-bottom:32px; }
.viz-header h2 { font-family:'Space Grotesk',sans-serif; font-size:24px; font-weight:700; margin-bottom:4px; letter-spacing:-0.02em; }
.viz-header p { font-size:14px; color:var(--text-m); }
.section-eyebrow { font-size:11px; font-weight:600; letter-spacing:3px; text-transform:uppercase; color:var(--accent); margin-bottom:8px; }

/* Stat Cards Row */
.stat-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-bottom:48px; }
.stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:24px; text-align:center; transition:border-color .2s; }
.stat-card:hover { border-color:var(--border-hover); }
.stat-card .num { font-family:'Space Grotesk',sans-serif; font-size:36px; font-weight:800; line-height:1; }
.stat-card .label { font-size:12px; color:var(--text-m); text-transform:uppercase; letter-spacing:1.5px; margin-top:6px; font-weight:500; }

/* Heatmap */
#heatmap { width:100%; height:550px; border-radius:var(--radius); border:1px solid var(--border); overflow:hidden; }

/* Bar Charts */
.bar-chart { display:flex; flex-direction:column; gap:8px; }
.bar-row { display:flex; align-items:center; gap:12px; }
.bar-label { width:180px; font-size:13px; font-weight:500; text-align:right; flex-shrink:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--text-s); }
.bar-track { flex:1; height:32px; background:var(--bg-t); border-radius:6px; overflow:hidden; position:relative; }
.bar-fill { height:100%; border-radius:6px; transition:width 1s cubic-bezier(.4,0,.2,1); display:flex; align-items:center; padding-left:10px; }
.bar-fill span { font-size:12px; font-weight:700; color:#fff; white-space:nowrap; }
.bar-count { width:36px; font-size:13px; font-weight:600; color:var(--text-s); text-align:left; flex-shrink:0; }

/* Treemap */
.treemap { display:grid; gap:4px; min-height:400px; }
.treemap-cell { border-radius:8px; padding:16px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; transition:opacity .15s, transform .15s; position:relative; overflow:hidden; }
.treemap-cell:hover { opacity:0.9; transform:scale(1.01); }
.treemap-cell .cell-icon { font-size:24px; }
.treemap-cell .cell-name { font-size:14px; font-weight:700; color:#fff; }
.treemap-cell .cell-count { font-size:12px; color:rgba(255,255,255,0.8); }
.treemap-cell .cell-pct { position:absolute; top:12px; right:14px; font-size:20px; font-weight:800; color:rgba(255,255,255,0.25); }

/* Bubble Grid (Valuations) */
.bubble-grid { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:center; padding:20px 0; }
.bubble { border-radius:50%; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; transition:transform .2s; cursor:default; border:2px solid rgba(255,255,255,0.15); }
.bubble:hover { transform:scale(1.08); border-color:var(--accent); }
.bubble .b-name { font-size:10px; font-weight:700; color:#fff; line-height:1.2; padding:0 4px; }
.bubble .b-val { font-size:9px; color:rgba(255,255,255,0.8); }

/* Funding Pipeline */
.pipeline { display:flex; gap:2px; align-items:stretch; min-height:300px; }
.pipeline-col { flex:1; display:flex; flex-direction:column; align-items:center; }
.pipeline-bar { width:100%; border-radius:8px 8px 0 0; display:flex; align-items:flex-end; justify-content:center; padding-bottom:12px; transition:height 1s cubic-bezier(.4,0,.2,1); }
.pipeline-bar span { font-size:20px; font-weight:800; color:#fff; }
.pipeline-label { padding:12px 4px; text-align:center; }
.pipeline-label .p-stage { font-size:11px; font-weight:600; color:var(--text); }
.pipeline-label .p-count { font-size:10px; color:var(--text-m); margin-top:2px; }

/* City Grid */
.city-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; }
.city-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:16px 20px; display:flex; align-items:center; gap:14px; transition:border-color .15s, box-shadow .15s; }
.city-card:hover { border-color:var(--border-hover); box-shadow:var(--shadow-md); }
.city-rank { font-family:'Space Grotesk',sans-serif; font-size:24px; font-weight:800; color:var(--text-m); width:32px; text-align:center; }
.city-card:nth-child(1) .city-rank { color:var(--accent); }
.city-card:nth-child(2) .city-rank { color:#60a5fa; }
.city-card:nth-child(3) .city-rank { color:#8b5cf6; }
.city-info .city-name { font-size:14px; font-weight:600; color:var(--text); }
.city-info .city-count { font-size:12px; color:var(--text-m); }

/* Footer */
.footer { background:var(--bg-s); border-top:1px solid var(--border); color:#fff; padding:32px 0; text-align:center; }
.footer p { font-size:13px; color:var(--text-m); }
.footer a { color:var(--text-s); text-decoration:none; }
.footer a:hover { color:var(--accent); }

/* Two column layout */
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:32px; }

/* Dark Leaflet overrides */
.leaflet-container { background:#0a0a0a !important; }
.leaflet-control-zoom a { background:rgba(20,20,20,0.9)!important; color:var(--text)!important; border-color:var(--border)!important; }
.leaflet-control-zoom a:hover { background:rgba(30,30,30,0.95)!important; }
.leaflet-control-attribution { background:rgba(0,0,0,0.7)!important; color:var(--text-m)!important; }
.leaflet-control-attribution a { color:var(--text-s)!important; }
.leaflet-popup-content-wrapper { background:var(--bg-t)!important; color:var(--text)!important; border-radius:8px!important; box-shadow:var(--shadow-md)!important; }
.leaflet-popup-tip { background:var(--bg-t)!important; }

/* Responsive */
@media(max-width:768px) {
  .nav { padding:0 16px; }
  .nav-links { display:none; }
  .hero { padding:80px 16px 40px; }
  .stat-row { grid-template-columns:repeat(2,1fr); }
  .two-col { grid-template-columns:1fr; }
  .bar-label { width:120px; font-size:11px; }
  .pipeline { flex-wrap:wrap; }
  .pipeline-col { min-width:60px; }
}

/* Scrollbar */
::-webkit-scrollbar { width:8px; height:8px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.15); border-radius:4px; }
::-webkit-scrollbar-thumb:hover { background:rgba(255,255,255,0.25); }

/* Animate in */
.animate-in { opacity:0; transform:translateY(16px); transition:opacity .6s ease, transform .6s ease; }
.animate-in.visible { opacity:1; transform:translateY(0); }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-brand">
        <div class="nav-logo">ROS</div>
        <span class="nav-title">THE INNOVATORS LEAGUE</span>
    </div>
    <div class="nav-links">
        <a href="index.html#discovery-hub" class="nav-link">üó∫Ô∏è Map</a>
        <a href="index.html#discovery-hub" class="nav-link">üìä Database</a>
        <a href="index.html#innovator50" class="nav-link">üèÜ ROS 50</a>
        <a href="visualizations.html" class="nav-link active">üìà Insights</a>
        <a href="investors.html" class="nav-link">üí∞ Investors</a>
        <a href="jobs.html" class="nav-link">üíº Jobs</a>
        <a href="https://www.rationaloptimistsociety.com" target="_blank" rel="noopener" class="nav-cta">Join ROS</a>
    </div>
</nav>

<header class="hero">
    <p class="section-eyebrow">RATIONAL OPTIMIST SOCIETY</p>
    <h1>Innovation Insights</h1>
    <p id="hero-subtitle">Interactive data visualizations from The Innovators League &mdash; loading...</p>
</header>

<!-- Key Stats -->
<section class="viz-section">
    <div class="container">
        <div class="stat-row" id="stat-row"></div>
    </div>
</section>

<!-- 1. Innovation Hotspots Heatmap -->
<section class="viz-section" id="hotspots">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">GEOGRAPHY</p>
            <h2>Innovation Hotspots</h2>
            <p>Where the world's most ambitious startups cluster. Brighter = more companies.</p>
        </div>
        <div id="heatmap" class="animate-in"></div>
    </div>
</section>

<!-- 2. Sector Treemap -->
<section class="viz-section" id="sectors">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">SECTORS</p>
            <h2>Sectors of Disruption</h2>
            <p id="sectors-subtitle">What these companies are building, by category.</p>
        </div>
        <div class="treemap animate-in" id="treemap"></div>
    </div>
</section>

<!-- 3. Top Cities + Country Bar Chart -->
<section class="viz-section" id="cities">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">LOCATIONS</p>
            <h2>Global Innovation Capitals</h2>
            <p>The cities and countries where the future is being built.</p>
        </div>
        <div class="two-col">
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">Top Cities</h3>
                <div class="city-grid" id="city-grid"></div>
            </div>
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">Companies by Country</h3>
                <div class="bar-chart" id="country-bars"></div>
            </div>
        </div>
    </div>
</section>

<!-- 4. Funding Pipeline -->
<section class="viz-section" id="funding">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">CAPITAL</p>
            <h2>The Funding Pipeline</h2>
            <p>From seed to public markets &mdash; how these companies are funded.</p>
        </div>
        <div class="pipeline animate-in" id="pipeline"></div>
    </div>
</section>

<!-- 5. Valuation Bubbles -->
<section class="viz-section" id="valuations">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">VALUATIONS</p>
            <h2>The Billion-Dollar Map</h2>
            <p>Every company with a known valuation, sized by market cap.</p>
        </div>
        <div class="bubble-grid animate-in" id="bubble-grid"></div>
    </div>
</section>

<!-- 6. US Deep Dive (still interesting with global data) -->
<section class="viz-section" id="us-deep-dive" style="background:var(--bg-s);">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">DEEP DIVE</p>
            <h2>The California Dominance</h2>
            <p id="california-subtitle">California companies loading...</p>
        </div>
        <div class="two-col">
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">LA's Defense Tech Corridor</h3>
                <div class="bar-chart" id="la-bars"></div>
                <p style="font-size:12px;color:var(--text-m);margin-top:12px;">El Segundo, Torrance, and Hawthorne house dozens of companies &mdash; the new defense tech heartland.</p>
            </div>
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">CA Sectors</h3>
                <div class="bar-chart" id="ca-sector-bars"></div>
            </div>
        </div>
    </div>
</section>

<!-- NEW VISUALIZATIONS -->

<!-- Score Radar Charts -->
<section class="viz-section" id="score-radar">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">COMPANY PROFILES</p>
            <h2>Innovation Score Radar</h2>
            <p>6-dimensional company profiles ‚Äî compare tech moat, momentum, team pedigree, market gravity, capital efficiency, and gov traction.</p>
        </div>
        <div class="radar-controls" style="display:flex;gap:16px;margin-bottom:24px;flex-wrap:wrap;">
            <select id="radar-company-1" class="viz-select" style="flex:1;min-width:200px;padding:12px;background:var(--bg-t);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:14px;"></select>
            <select id="radar-company-2" class="viz-select" style="flex:1;min-width:200px;padding:12px;background:var(--bg-t);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:14px;"></select>
            <select id="radar-company-3" class="viz-select" style="flex:1;min-width:200px;padding:12px;background:var(--bg-t);color:var(--text);border:1px solid var(--border);border-radius:8px;font-size:14px;"></select>
        </div>
        <div id="radar-chart" style="width:100%;max-width:600px;margin:0 auto;aspect-ratio:1;position:relative;"></div>
        <div id="radar-legend" style="display:flex;justify-content:center;gap:24px;margin-top:24px;flex-wrap:wrap;"></div>
    </div>
</section>

<!-- Growth Signal Heat Timeline -->
<section class="viz-section" id="signal-timeline" style="background:var(--bg-s);">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">SIGNAL VELOCITY</p>
            <h2>Growth Signal Timeline</h2>
            <p>Recent momentum signals across the frontier tech landscape ‚Äî hiring surges, contracts, breakthroughs, and more.</p>
        </div>
        <div id="signal-timeline-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;"></div>
    </div>
</section>

<!-- Founder Mafia Networks -->
<section class="viz-section" id="mafia-network">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">TALENT NETWORKS</p>
            <h2>Founder Mafia Networks</h2>
            <p>Elite alumni networks producing disproportionate startup founders ‚Äî SpaceX, Palantir, Google, and more.</p>
        </div>
        <div id="mafia-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(320px,1fr));gap:20px;"></div>
    </div>
</section>

<!-- Revenue vs Valuation Efficiency -->
<section class="viz-section" id="efficiency" style="background:var(--bg-s);">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">CAPITAL EFFICIENCY</p>
            <h2>Revenue vs Valuation</h2>
            <p>Identifying over/undervalued companies based on revenue-to-valuation multiples. Higher efficiency = stronger business fundamentals.</p>
        </div>
        <div id="efficiency-chart" style="display:flex;flex-direction:column;gap:12px;"></div>
    </div>
</section>

<!-- Sector Momentum Dashboard -->
<section class="viz-section" id="sector-momentum" style="background:linear-gradient(135deg, rgba(255,107,44,0.03) 0%, transparent 100%);">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">MARKET DYNAMICS</p>
            <h2>Sector Momentum Dashboard</h2>
            <p>Real-time momentum scores across frontier tech sectors ‚Äî tracking funding velocity, regulatory progress, and breakout catalysts.</p>
        </div>

        <!-- Momentum Stats -->
        <div id="momentum-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:16px;margin-bottom:32px;"></div>

        <!-- Momentum Bars -->
        <div id="momentum-bars" style="display:flex;flex-direction:column;gap:16px;margin-bottom:32px;"></div>

        <!-- Catalysts Grid -->
        <div style="margin-top:32px;">
            <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">üî• Key Catalysts by Sector</h3>
            <div id="catalysts-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(300px,1fr));gap:16px;"></div>
        </div>
    </div>
</section>

<!-- Patent & IP Moat Tracker -->
<section class="viz-section" id="patent-tracker">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">INTELLECTUAL PROPERTY</p>
            <h2>Patent & IP Moat Tracker</h2>
            <p>Deep analysis of patent portfolios, filing velocity, and technology moats across frontier tech companies.</p>
        </div>

        <!-- Patent Stats Banner -->
        <div id="patent-stats" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px;"></div>

        <!-- Filters -->
        <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px;">
            <select id="patent-moat-filter" style="padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;">
                <option value="all">All IP Moat Scores</option>
                <option value="high">High Moat (8+)</option>
                <option value="medium">Medium Moat (6-7)</option>
                <option value="building">Building Moat (‚â§5)</option>
            </select>
            <select id="patent-velocity-filter" style="padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;">
                <option value="all">All Velocities</option>
                <option value="accelerating">Accelerating</option>
                <option value="steady">Steady</option>
            </select>
            <select id="patent-sort" style="padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;">
                <option value="patents">Sort by Patent Count</option>
                <option value="moat">Sort by IP Moat Score</option>
                <option value="velocity">Sort by Filing Velocity</option>
            </select>
        </div>

        <!-- Patent Cards Grid -->
        <div id="patent-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(380px,1fr));gap:20px;"></div>

        <p style="text-align:center;font-size:12px;color:var(--text-m);margin-top:24px;">Data from USPTO PatentsView API and company filings</p>
    </div>
</section>

<!-- Government Opportunity Tracker -->
<section class="viz-section" id="gov-opportunities">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">GOVERNMENT DEMAND</p>
            <h2>Open Opportunities</h2>
            <p>Active RFPs, BAAs, and SBIRs from defense and government agencies ‚Äî matched to relevant frontier tech companies.</p>
        </div>

        <!-- Stats Banner -->
        <div id="gov-stats-banner" style="display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));gap:16px;margin-bottom:24px;"></div>

        <!-- Filters -->
        <div style="display:flex;flex-wrap:wrap;gap:12px;margin-bottom:24px;">
            <select id="gov-agency-filter" style="padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;">
                <option value="all">All Agencies</option>
            </select>
            <select id="gov-type-filter" style="padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;">
                <option value="all">All Types</option>
            </select>
            <select id="gov-priority-filter" style="padding:8px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;color:var(--text);font-size:14px;">
                <option value="all">All Priorities</option>
                <option value="Critical">Critical</option>
                <option value="High">High</option>
                <option value="Medium">Medium</option>
            </select>
        </div>

        <div id="gov-tracker-grid" style="display:grid;grid-template-columns:repeat(auto-fill,minmax(400px,1fr));gap:20px;"></div>

        <p id="gov-last-updated" style="text-align:center;font-size:12px;color:var(--text-m);margin-top:24px;"></p>
    </div>
</section>

<footer class="footer">
    <div class="container">
        <p>&copy; 2026 <a href="https://www.rationaloptimistsociety.com" target="_blank">Rational Optimist Society</a> &middot; <a href="index.html">Back to Database</a></p>
    </div>
</footer>

<script src="data.js?v=32"></script>
<script>
// ‚îÄ‚îÄ‚îÄ COUNTRY HELPER (matches app.js logic) ‚îÄ‚îÄ‚îÄ
const INTL_CODES_VIZ = {
  'UK':'United Kingdom','GB':'United Kingdom','FR':'France','SE':'Sweden','FI':'Finland',
  'CH':'Switzerland','DK':'Denmark','NO':'Norway','NL':'Netherlands','ES':'Spain',
  'IT':'Italy','EE':'Estonia','PL':'Poland','JP':'Japan','KR':'South Korea',
  'AU':'Australia','SG':'Singapore','NZ':'New Zealand','ZA':'South Africa','BR':'Brazil',
  'IE':'Ireland','CA-CAN':'Canada','PT':'Portugal','CZ':'Czech Republic'
};
const LOC_COUNTRIES = {'Germany':'Germany','Israel':'Israel','India':'India','Argentina':'Argentina','Ireland':'Ireland'};

function getCountryViz(stateCode, location) {
  if (INTL_CODES_VIZ[stateCode]) return INTL_CODES_VIZ[stateCode];
  if (location) {
    for (const [kw, country] of Object.entries(LOC_COUNTRIES)) {
      if (location.includes(kw)) return country;
    }
  }
  return 'United States';
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function parseVal(str) {
  if (!str) return 0;
  str = str.replace(/[^0-9.BMK+$T]/g,'');
  let num = parseFloat(str.replace(/[^0-9.]/g,'')) || 0;
  if (str.includes('T')) num *= 1000;
  else if (str.includes('B')) num *= 1;
  else if (str.includes('M')) num /= 1000;
  else if (str.includes('K')) num /= 1000000;
  return num;
}

const sectorColors = {};
Object.entries(SECTORS).forEach(([name, info]) => { sectorColors[name] = info.color; });

// ‚îÄ‚îÄ‚îÄ 0. KEY STATS ‚îÄ‚îÄ‚îÄ
(function() {
  const total = COMPANIES.length;
  const sectorCount = Object.keys(SECTORS).length;
  const countries = new Set(COMPANIES.map(c => getCountryViz(c.state, c.location)));
  const countryCount = countries.size;
  const cities = new Set(COMPANIES.map(c => c.location)).size;
  const caCount = COMPANIES.filter(c => c.state === 'CA').length;
  const withVal = COMPANIES.filter(c => c.valuation).length;

  const stats = [
    { num: total, label: 'Companies Tracked', color: 'var(--accent)' },
    { num: sectorCount, label: 'Sectors', color: '#3b82f6' },
    { num: countryCount, label: 'Countries', color: '#8b5cf6' },
    { num: cities, label: 'Cities', color: '#6366f1' },
    { num: caCount, label: 'Based in California', color: '#22c55e' },
    { num: withVal, label: 'With Valuations', color: '#f59e0b' }
  ];

  const row = document.getElementById('stat-row');
  stats.forEach(s => {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `<div class="num" style="color:${s.color}">${s.num}</div><div class="label">${s.label}</div>`;
    row.appendChild(card);
  });

  document.getElementById('hero-subtitle').innerHTML =
    `Interactive data visualizations from The Innovators League &mdash; ${total} companies across ${countryCount} countries reshaping the world.`;
  document.getElementById('sectors-subtitle').textContent =
    `What these ${total} companies are building, by category.`;
  const caPct = Math.round(caCount / total * 100);
  document.getElementById('california-subtitle').textContent =
    `${caCount} of ${total} companies (${caPct}%) are based in California. Here's where they are.`;
})();

// ‚îÄ‚îÄ‚îÄ 1. HEATMAP (global, dark tiles) ‚îÄ‚îÄ‚îÄ
(function() {
  const map = L.map('heatmap', { center:[25,0], zoom:2, minZoom:2, maxZoom:12, scrollWheelZoom:true, zoomControl:true });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; OpenStreetMap &copy; CARTO', maxZoom:19
  }).addTo(map);

  const heatData = COMPANIES.filter(c => c.lat && c.lng).map(c => [c.lat, c.lng, 0.7]);
  L.heatLayer(heatData, { radius:28, blur:20, maxZoom:10, max:1.0,
    gradient: { 0.2:'rgba(255,107,44,0.15)', 0.4:'rgba(255,107,44,0.3)', 0.6:'#FF6B2C', 0.8:'#FF8147', 1.0:'#FF9560' }
  }).addTo(map);

  COMPANIES.forEach(c => {
    if (!c.lat || !c.lng) return;
    const color = sectorColors[c.sector] || '#6b7280';
    L.circleMarker([c.lat, c.lng], { radius:5, fillColor:color, color:'rgba(255,255,255,0.3)', weight:1, fillOpacity:0.9 })
      .bindPopup(`<strong>${c.name}</strong><br><span style="color:${color}">${c.sector}</span><br><small>${c.location}</small>`)
      .addTo(map);
  });
})();

// ‚îÄ‚îÄ‚îÄ 2. TREEMAP ‚îÄ‚îÄ‚îÄ
(function() {
  const counts = {};
  COMPANIES.forEach(c => { counts[c.sector] = (counts[c.sector]||0)+1; });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
  const total = COMPANIES.length;

  const grid = document.getElementById('treemap');
  const rows = [];
  let row = [];
  let rowTotal = 0;
  const targetPerRow = total / 3;

  sorted.forEach(([sector, count]) => {
    row.push({ sector, count });
    rowTotal += count;
    if (rowTotal >= targetPerRow && rows.length < 2) {
      rows.push([...row]);
      row = [];
      rowTotal = 0;
    }
  });
  if (row.length) rows.push(row);

  grid.style.gridTemplateRows = rows.map(r => {
    const rowSum = r.reduce((a,b) => a+b.count, 0);
    return `${Math.max(rowSum/total*100, 20)}fr`;
  }).join(' ');

  rows.forEach(r => {
    const rowDiv = document.createElement('div');
    rowDiv.style.display = 'grid';
    rowDiv.style.gridTemplateColumns = r.map(s => `${s.count}fr`).join(' ');
    rowDiv.style.gap = '4px';

    r.forEach(({ sector, count }) => {
      const info = SECTORS[sector] || { color: '#6b7280', icon: 'üì¶' };
      const pct = Math.round(count/total*100);
      const cell = document.createElement('div');
      cell.className = 'treemap-cell';
      cell.style.background = info.color;
      cell.innerHTML = `
        <div><div class="cell-icon">${info.icon}</div><div class="cell-name">${sector}</div></div>
        <div class="cell-count">${count} companies</div>
        <div class="cell-pct">${pct}%</div>
      `;
      cell.addEventListener('click', () => { window.location.href = `index.html?sector=${encodeURIComponent(sector)}#companies`; });
      rowDiv.appendChild(cell);
    });

    grid.appendChild(rowDiv);
  });
})();

// ‚îÄ‚îÄ‚îÄ 3. CITIES + COUNTRY BARS ‚îÄ‚îÄ‚îÄ
(function() {
  // Cities
  const cityCounts = {};
  COMPANIES.forEach(c => { cityCounts[c.location] = (cityCounts[c.location]||0)+1; });
  const topCities = Object.entries(cityCounts).sort((a,b) => b[1]-a[1]).slice(0,12);

  const cityGrid = document.getElementById('city-grid');
  topCities.forEach(([city, count], i) => {
    const card = document.createElement('div');
    card.className = 'city-card';
    card.innerHTML = `
      <div class="city-rank">${i+1}</div>
      <div class="city-info"><div class="city-name">${city}</div><div class="city-count">${count} ${count===1?'company':'companies'}</div></div>
    `;
    cityGrid.appendChild(card);
  });

  // Countries instead of states
  const countryCounts = {};
  COMPANIES.forEach(c => {
    const country = getCountryViz(c.state, c.location);
    countryCounts[country] = (countryCounts[country]||0)+1;
  });
  const topCountries = Object.entries(countryCounts).sort((a,b) => b[1]-a[1]);
  const maxCountry = topCountries[0][1];

  const countryColors = {
    'United States':'#FF6B2C', 'United Kingdom':'#3b82f6', 'Germany':'#dc2626',
    'France':'#6366f1', 'Israel':'#f59e0b', 'Japan':'#ec4899', 'Canada':'#22c55e',
    'Sweden':'#14b8a6', 'Finland':'#60a5fa', 'Switzerland':'#f97316', 'India':'#8b5cf6',
    'South Korea':'#06b6d4', 'Australia':'#a855f7'
  };
  const countryBars = document.getElementById('country-bars');

  topCountries.forEach(([country, count]) => {
    const pct = (count/maxCountry*100);
    const color = countryColors[country] || '#6b7280';
    const row = document.createElement('div');
    row.className = 'bar-row';
    row.innerHTML = `
      <div class="bar-label">${country}</div>
      <div class="bar-track"><div class="bar-fill" style="width:0;background:${color}"><span>${count}</span></div></div>
    `;
    countryBars.appendChild(row);
    setTimeout(() => { row.querySelector('.bar-fill').style.width = pct + '%'; }, 300);
  });
})();

// ‚îÄ‚îÄ‚îÄ 4. FUNDING PIPELINE ‚îÄ‚îÄ‚îÄ
(function() {
  const stageCounts = {};
  COMPANIES.forEach(c => { if(c.fundingStage) stageCounts[c.fundingStage] = (stageCounts[c.fundingStage]||0)+1; });

  const simplified = [
    { label:'Seed', stages:['Seed','Early Stage'], color:'rgba(223,241,64,0.4)' },
    { label:'Series A', stages:['Series A'], color:'rgba(223,241,64,0.5)' },
    { label:'Series B', stages:['Series B'], color:'rgba(223,241,64,0.6)' },
    { label:'Series C', stages:['Series C'], color:'rgba(223,241,64,0.75)' },
    { label:'Series D+', stages:['Series D','Series E','Series F','Series G'], color:'#FF6B2C' },
    { label:'Late Stage', stages:['Late Stage','Private'], color:'#FF8147' },
    { label:'Public', stages:['Public','Alphabet subsidiary'], color:'#FF9560' }
  ];

  simplified.forEach(s => {
    s.count = s.stages.reduce((a,st) => a + (stageCounts[st]||0), 0);
  });

  const maxCount = Math.max(...simplified.map(s => s.count));
  const pipeline = document.getElementById('pipeline');

  simplified.forEach(s => {
    const pct = (s.count/maxCount*100);
    const col = document.createElement('div');
    col.className = 'pipeline-col';
    col.innerHTML = `
      <div class="pipeline-bar" style="height:0;background:${s.color}"><span>${s.count}</span></div>
      <div class="pipeline-label"><div class="p-stage">${s.label}</div><div class="p-count">${s.count} companies</div></div>
    `;
    pipeline.appendChild(col);
    setTimeout(() => { col.querySelector('.pipeline-bar').style.height = Math.max(pct, 8) + '%'; }, 500);
  });
})();

// ‚îÄ‚îÄ‚îÄ 5. VALUATION BUBBLES ‚îÄ‚îÄ‚îÄ
(function() {
  const valued = COMPANIES.filter(c => c.valuation && c.valuation.includes('$')).map(c => ({
    name: c.name, sector: c.sector, val: c.valuation, num: parseVal(c.valuation)
  })).sort((a,b) => b.num - a.num);

  const grid = document.getElementById('bubble-grid');
  if (!valued.length) return;
  const maxVal = valued[0].num;

  valued.forEach(v => {
    const size = Math.max(Math.sqrt(v.num / maxVal) * 160, 56);
    const color = sectorColors[v.sector] || '#6b7280';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.style.width = size + 'px';
    bubble.style.height = size + 'px';
    bubble.style.background = color;
    bubble.title = `${v.name}: ${v.val}`;
    if (size > 70) {
      bubble.innerHTML = `<div class="b-name">${v.name}</div><div class="b-val">${v.val}</div>`;
    } else {
      bubble.innerHTML = `<div class="b-name" style="font-size:8px">${v.name}</div>`;
    }
    grid.appendChild(bubble);
  });
})();

// ‚îÄ‚îÄ‚îÄ 6. CALIFORNIA DEEP DIVE ‚îÄ‚îÄ‚îÄ
(function() {
  const laCorridorCities = ['El Segundo, CA','Torrance, CA','Hawthorne, CA','Redondo Beach, CA','Playa Vista, CA','Gardena, CA','Chatsworth, CA','Culver City, CA','Long Beach, CA','Huntington Beach, CA','Costa Mesa, CA','Irvine, CA'];
  const laCounts = {};
  COMPANIES.forEach(c => { if (laCorridorCities.includes(c.location)) laCounts[c.location] = (laCounts[c.location]||0)+1; });
  const laTop = Object.entries(laCounts).sort((a,b) => b[1]-a[1]);
  const maxLA = laTop[0] ? laTop[0][1] : 1;

  const laBars = document.getElementById('la-bars');
  const laColors = ['#FF6B2C','#FF8147','#FF9560','#FFB088','#FFD0B5','#60a5fa','#3b82f6','#2563eb','#1d4ed8','#1e3a8a'];

  laTop.forEach(([city, count], i) => {
    const pct = (count/maxLA*100);
    const row = document.createElement('div');
    row.className = 'bar-row';
    row.innerHTML = `
      <div class="bar-label">${city.replace(', CA','')}</div>
      <div class="bar-track"><div class="bar-fill" style="width:0;background:${laColors[i]||'#6b7280'}"><span>${count}</span></div></div>
    `;
    laBars.appendChild(row);
    setTimeout(() => { row.querySelector('.bar-fill').style.width = pct+'%'; }, 400);
  });

  // CA sectors
  const caSectors = {};
  COMPANIES.filter(c => c.state === 'CA').forEach(c => { caSectors[c.sector] = (caSectors[c.sector]||0)+1; });
  const caTop = Object.entries(caSectors).sort((a,b) => b[1]-a[1]);
  const maxCAS = caTop[0] ? caTop[0][1] : 1;

  const caBars = document.getElementById('ca-sector-bars');
  caTop.forEach(([sector, count]) => {
    const pct = (count/maxCAS*100);
    const color = sectorColors[sector] || '#6b7280';
    const row = document.createElement('div');
    row.className = 'bar-row';
    row.innerHTML = `
      <div class="bar-label">${sector}</div>
      <div class="bar-track"><div class="bar-fill" style="width:0;background:${color}"><span>${count}</span></div></div>
    `;
    caBars.appendChild(row);
    setTimeout(() => { row.querySelector('.bar-fill').style.width = pct+'%'; }, 400);
  });
})();

// ‚îÄ‚îÄ‚îÄ 7. SCORE RADAR CHARTS ‚îÄ‚îÄ‚îÄ
(function() {
  if (typeof INNOVATOR_SCORES === 'undefined') return;

  const dimensions = ['techMoat', 'momentum', 'teamPedigree', 'marketGravity', 'capitalEfficiency', 'govTraction'];
  const dimLabels = { techMoat: 'Tech Moat', momentum: 'Momentum', teamPedigree: 'Team', marketGravity: 'Market', capitalEfficiency: 'Efficiency', govTraction: 'Gov Traction' };
  const colors = ['#FF6B2C', '#3b82f6', '#22c55e'];

  const companies = INNOVATOR_SCORES.filter(s => s.composite >= 70).slice(0, 20);

  // Populate dropdowns
  const selects = [document.getElementById('radar-company-1'), document.getElementById('radar-company-2'), document.getElementById('radar-company-3')];
  selects.forEach((sel, i) => {
    sel.innerHTML = '<option value="">Select Company ' + (i+1) + '</option>' +
      companies.map(c => '<option value="' + c.company + '">' + c.company + ' (' + c.composite + ')</option>').join('');
    if (companies[i]) sel.value = companies[i].company;
    sel.addEventListener('change', renderRadar);
  });

  function renderRadar() {
    const chart = document.getElementById('radar-chart');
    const legend = document.getElementById('radar-legend');
    const selected = selects.map(s => companies.find(c => c.company === s.value)).filter(Boolean);

    if (!selected.length) {
      chart.innerHTML = '<p style="text-align:center;color:var(--text-m);padding:60px;">Select companies to compare</p>';
      legend.innerHTML = '';
      return;
    }

    const size = Math.min(chart.clientWidth, 500);
    const cx = size / 2, cy = size / 2, r = size * 0.38;

    let svg = '<svg width="' + size + '" height="' + size + '" style="display:block;margin:0 auto;">';

    // Draw grid circles
    for (let i = 1; i <= 5; i++) {
      const pr = r * (i / 5);
      svg += '<circle cx="' + cx + '" cy="' + cy + '" r="' + pr + '" fill="none" stroke="rgba(255,255,255,0.08)" stroke-width="1"/>';
    }

    // Draw axes
    dimensions.forEach((dim, i) => {
      const angle = (Math.PI * 2 * i / dimensions.length) - Math.PI / 2;
      const x2 = cx + r * Math.cos(angle);
      const y2 = cy + r * Math.sin(angle);
      svg += '<line x1="' + cx + '" y1="' + cy + '" x2="' + x2 + '" y2="' + y2 + '" stroke="rgba(255,255,255,0.1)" stroke-width="1"/>';
      const lx = cx + (r + 24) * Math.cos(angle);
      const ly = cy + (r + 24) * Math.sin(angle);
      svg += '<text x="' + lx + '" y="' + ly + '" text-anchor="middle" dominant-baseline="middle" fill="rgba(255,255,255,0.5)" font-size="11" font-family="Inter">' + dimLabels[dim] + '</text>';
    });

    // Draw company polygons
    selected.forEach((comp, ci) => {
      const points = dimensions.map((dim, i) => {
        const val = comp[dim] || 5;
        const pr = r * (val / 10);
        const angle = (Math.PI * 2 * i / dimensions.length) - Math.PI / 2;
        return (cx + pr * Math.cos(angle)) + ',' + (cy + pr * Math.sin(angle));
      }).join(' ');
      svg += '<polygon points="' + points + '" fill="' + colors[ci] + '22" stroke="' + colors[ci] + '" stroke-width="2"/>';

      // Draw dots
      dimensions.forEach((dim, i) => {
        const val = comp[dim] || 5;
        const pr = r * (val / 10);
        const angle = (Math.PI * 2 * i / dimensions.length) - Math.PI / 2;
        const px = cx + pr * Math.cos(angle);
        const py = cy + pr * Math.sin(angle);
        svg += '<circle cx="' + px + '" cy="' + py + '" r="4" fill="' + colors[ci] + '"/>';
      });
    });

    svg += '</svg>';
    chart.innerHTML = svg;

    // Legend
    legend.innerHTML = selected.map((c, i) =>
      '<div style="display:flex;align-items:center;gap:8px;"><span style="width:16px;height:16px;background:' + colors[i] + ';border-radius:50%;"></span><span style="font-size:14px;font-weight:600;">' + c.company + '</span><span style="font-size:12px;color:var(--text-m);">(' + c.composite + ')</span></div>'
    ).join('');
  }

  renderRadar();
})();

// ‚îÄ‚îÄ‚îÄ 8. GROWTH SIGNAL TIMELINE ‚îÄ‚îÄ‚îÄ
(function() {
  if (typeof GROWTH_SIGNALS === 'undefined') return;

  const grid = document.getElementById('signal-timeline-grid');
  const signalIcons = {
    hiring_surge: 'üë•', government_contract: 'üèõÔ∏è', revenue_acceleration: 'üí∞',
    valuation_jump: 'üìà', facility_expansion: 'üèóÔ∏è', product_launch: 'üöÄ',
    technical_breakthrough: '‚ö°', regulatory_progress: '‚úÖ', customer_win: 'üéØ',
    market_expansion: 'üåç', partnership: 'ü§ù', discovery: 'üî¨'
  };

  const signals = GROWTH_SIGNALS.slice(0, 12);

  signals.forEach(sig => {
    const card = document.createElement('div');
    card.style.cssText = 'background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;transition:border-color .2s;';
    card.onmouseenter = () => card.style.borderColor = 'var(--border-hover)';
    card.onmouseleave = () => card.style.borderColor = 'var(--border)';

    const strengthColor = sig.strength === 'strong' ? '#22c55e' : sig.strength === 'medium' ? '#f59e0b' : '#6b7280';

    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <span style="font-size:24px;">${signalIcons[sig.signal] || 'üìä'}</span>
        <span style="font-size:11px;padding:4px 10px;background:${strengthColor}22;color:${strengthColor};border-radius:20px;font-weight:600;text-transform:uppercase;">${sig.strength}</span>
      </div>
      <div style="font-size:16px;font-weight:700;color:var(--text);margin-bottom:6px;">${sig.company}</div>
      <div style="font-size:13px;color:var(--text-s);margin-bottom:10px;">${sig.detail}</div>
      <div style="font-size:11px;color:var(--text-m);">${sig.date}</div>
    `;
    grid.appendChild(card);
  });
})();

// ‚îÄ‚îÄ‚îÄ 9. FOUNDER MAFIA NETWORKS ‚îÄ‚îÄ‚îÄ
(function() {
  if (typeof FOUNDER_MAFIAS === 'undefined') return;

  const grid = document.getElementById('mafia-grid');
  const mafiaColors = { 'SpaceX Mafia': '#FF6B2C', 'Palantir Mafia': '#8b5cf6', 'PayPal Mafia': '#3b82f6', 'Google Mafia': '#22c55e', 'Stripe Mafia': '#6366f1', 'Meta Mafia': '#0ea5e9' };

  Object.entries(FOUNDER_MAFIAS).forEach(([name, data]) => {
    const color = mafiaColors[name] || '#f59e0b';
    const card = document.createElement('div');
    card.style.cssText = 'background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;';

    card.innerHTML = `
      <div style="display:flex;align-items:center;gap:12px;margin-bottom:16px;">
        <div style="width:40px;height:40px;background:${color}22;border-radius:50%;display:flex;align-items:center;justify-content:center;">
          <span style="font-size:20px;">${data.icon || 'üöÄ'}</span>
        </div>
        <div>
          <div style="font-size:16px;font-weight:700;color:var(--text);">${name}</div>
          <div style="font-size:12px;color:var(--text-m);">${data.description?.slice(0,50) || 'Elite founder network'}...</div>
        </div>
      </div>
      <div style="font-size:11px;color:var(--text-m);margin-bottom:12px;text-transform:uppercase;letter-spacing:1px;">Companies Founded:</div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        ${(data.companies || []).slice(0, 6).map(c =>
          '<span style="font-size:12px;padding:4px 10px;background:' + color + '15;color:' + color + ';border-radius:16px;font-weight:500;">' + c.company + '</span>'
        ).join('')}
      </div>
    `;
    grid.appendChild(card);
  });
})();

// ‚îÄ‚îÄ‚îÄ 10. REVENUE VS VALUATION EFFICIENCY ‚îÄ‚îÄ‚îÄ
(function() {
  if (typeof REVENUE_INTEL === 'undefined') return;

  const chart = document.getElementById('efficiency-chart');

  const data = REVENUE_INTEL.map(r => {
    const company = COMPANIES.find(c => c.name === r.company);
    const valNum = company?.valuation ? parseVal(company.valuation) : 0;
    const revStr = r.revenue.replace(/[^0-9.BMK]/g, '');
    let revNum = parseFloat(revStr.replace(/[^0-9.]/g, '')) || 0;
    if (revStr.includes('B')) revNum *= 1;
    else if (revStr.includes('M')) revNum /= 1000;

    return {
      company: r.company,
      revenue: r.revenue,
      valuation: company?.valuation || 'N/A',
      growth: r.growth,
      valNum,
      revNum,
      efficiency: valNum > 0 ? (revNum / valNum * 100).toFixed(1) : 0
    };
  }).filter(d => d.valNum > 0 && d.revNum > 0).sort((a, b) => b.efficiency - a.efficiency);

  const maxEff = Math.max(...data.map(d => parseFloat(d.efficiency)));

  data.forEach(d => {
    const pct = (parseFloat(d.efficiency) / maxEff * 100);
    const effColor = parseFloat(d.efficiency) > 30 ? '#22c55e' : parseFloat(d.efficiency) > 15 ? '#f59e0b' : '#ef4444';

    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:16px;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:8px;';
    row.innerHTML = `
      <div style="width:180px;flex-shrink:0;">
        <div style="font-size:14px;font-weight:600;color:var(--text);">${d.company}</div>
        <div style="font-size:11px;color:var(--text-m);">${d.revenue} rev / ${d.valuation} val</div>
      </div>
      <div style="flex:1;height:24px;background:var(--bg-t);border-radius:6px;overflow:hidden;">
        <div style="height:100%;width:${pct}%;background:${effColor};border-radius:6px;transition:width .6s;"></div>
      </div>
      <div style="width:80px;text-align:right;">
        <div style="font-size:16px;font-weight:700;color:${effColor};">${d.efficiency}%</div>
        <div style="font-size:10px;color:var(--text-m);">${d.growth}</div>
      </div>
    `;
    chart.appendChild(row);
  });
})();

// ‚îÄ‚îÄ‚îÄ 11. SECTOR MOMENTUM DASHBOARD ‚îÄ‚îÄ‚îÄ
(function() {
  if (typeof SECTOR_MOMENTUM === 'undefined') return;

  const statsContainer = document.getElementById('momentum-stats');
  const barsContainer = document.getElementById('momentum-bars');
  const catalystsGrid = document.getElementById('catalysts-grid');

  // Calculate stats
  const avgMomentum = Math.round(SECTOR_MOMENTUM.reduce((a, s) => a + s.momentum, 0) / SECTOR_MOMENTUM.length);
  const accelerating = SECTOR_MOMENTUM.filter(s => s.trend === 'accelerating').length;
  const totalFunding = SECTOR_MOMENTUM.reduce((a, s) => {
    const val = parseFloat(s.fundingQ?.replace(/[^0-9.]/g, '')) || 0;
    return a + val;
  }, 0);
  const hottest = SECTOR_MOMENTUM.reduce((a, b) => a.momentum > b.momentum ? a : b);

  // Render stats
  statsContainer.innerHTML = `
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:var(--accent);">${avgMomentum}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Avg Momentum</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:#22c55e;">${accelerating}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Accelerating</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:#3b82f6;">$${totalFunding.toFixed(1)}B</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Quarterly Funding</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:20px;font-weight:800;color:#f59e0b;">${hottest.sector}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Hottest Sector</div>
    </div>
  `;

  // Momentum colors
  const getMomentumColor = (m) => {
    if (m >= 90) return '#22c55e';
    if (m >= 75) return '#84cc16';
    if (m >= 60) return '#f59e0b';
    if (m >= 45) return '#fb923c';
    return '#6b7280';
  };

  const getTrendIcon = (t) => {
    if (t === 'accelerating') return 'üöÄ';
    if (t === 'rising') return 'üìà';
    return '‚Üí';
  };

  // Render momentum bars
  SECTOR_MOMENTUM.forEach((sector, i) => {
    const color = getMomentumColor(sector.momentum);
    const trendIcon = getTrendIcon(sector.trend);
    const trendColor = sector.trend === 'accelerating' ? '#22c55e' : sector.trend === 'rising' ? '#f59e0b' : '#6b7280';

    const row = document.createElement('div');
    row.style.cssText = 'display:flex;align-items:center;gap:16px;padding:12px 16px;background:var(--bg-card);border:1px solid var(--border);border-radius:10px;transition:all 0.2s;cursor:pointer;';
    row.onmouseenter = () => row.style.borderColor = 'var(--accent)';
    row.onmouseleave = () => row.style.borderColor = 'var(--border)';

    row.innerHTML = `
      <div style="width:180px;flex-shrink:0;">
        <div style="font-size:14px;font-weight:600;color:var(--text);">${sector.sector}</div>
        <div style="font-size:11px;color:${trendColor};font-weight:500;">${trendIcon} ${sector.trend}</div>
      </div>
      <div style="flex:1;height:28px;background:var(--bg-t);border-radius:6px;overflow:hidden;position:relative;">
        <div style="height:100%;width:0;background:linear-gradient(90deg,${color}88,${color});border-radius:6px;transition:width 1s cubic-bezier(.4,0,.2,1);display:flex;align-items:center;justify-content:flex-end;padding-right:12px;" class="momentum-fill" data-width="${sector.momentum}">
          <span style="font-size:13px;font-weight:700;color:#fff;">${sector.momentum}</span>
        </div>
      </div>
      <div style="width:80px;text-align:right;">
        <div style="font-size:14px;font-weight:700;color:#22c55e;">${sector.fundingQ}</div>
        <div style="font-size:10px;color:var(--text-m);">Q Funding</div>
      </div>
    `;

    barsContainer.appendChild(row);

    // Animate bar
    setTimeout(() => {
      row.querySelector('.momentum-fill').style.width = sector.momentum + '%';
    }, 100 + i * 50);
  });

  // Render catalysts grid
  SECTOR_MOMENTUM.slice(0, 6).forEach(sector => {
    const color = getMomentumColor(sector.momentum);
    const card = document.createElement('div');
    card.style.cssText = 'background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;transition:all 0.2s;';
    card.onmouseenter = () => card.style.borderColor = color;
    card.onmouseleave = () => card.style.borderColor = 'var(--border)';

    card.innerHTML = `
      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px;">
        <span style="font-size:14px;font-weight:700;color:var(--text);">${sector.sector}</span>
        <span style="font-size:20px;font-weight:800;color:${color};">${sector.momentum}</span>
      </div>
      <div style="display:flex;flex-wrap:wrap;gap:6px;">
        ${sector.catalysts.map(c => `<span style="font-size:11px;padding:4px 10px;background:${color}15;color:${color};border-radius:4px;font-weight:500;">${c}</span>`).join('')}
      </div>
    `;
    catalystsGrid.appendChild(card);
  });
})();

// ‚îÄ‚îÄ‚îÄ 12. PATENT & IP MOAT TRACKER ‚îÄ‚îÄ‚îÄ
(function() {
  if (typeof PATENT_INTEL === 'undefined') return;

  const statsContainer = document.getElementById('patent-stats');
  const patentGrid = document.getElementById('patent-grid');
  const moatFilter = document.getElementById('patent-moat-filter');
  const velocityFilter = document.getElementById('patent-velocity-filter');
  const sortSelect = document.getElementById('patent-sort');

  // Calculate stats
  const totalPatents = PATENT_INTEL.reduce((a, p) => a + p.totalPatents, 0);
  const avgMoat = (PATENT_INTEL.reduce((a, p) => a + p.ipMoatScore, 0) / PATENT_INTEL.length).toFixed(1);
  const acceleratingCount = PATENT_INTEL.filter(p => p.velocityTrend === 'accelerating').length;
  const topPatentHolder = PATENT_INTEL.reduce((a, b) => a.totalPatents > b.totalPatents ? a : b);

  // Render stats
  statsContainer.innerHTML = `
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:var(--accent);">${totalPatents.toLocaleString()}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Total Patents</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:#22c55e;">${avgMoat}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Avg IP Moat Score</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:#3b82f6;">${acceleratingCount}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Accelerating Filers</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:18px;font-weight:800;color:#f59e0b;">${topPatentHolder.company}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Top Patent Holder</div>
    </div>
  `;

  // IP Moat score colors
  const getMoatColor = (score) => {
    if (score >= 9) return '#22c55e';
    if (score >= 7) return '#84cc16';
    if (score >= 5) return '#f59e0b';
    return '#ef4444';
  };

  const getMoatLabel = (score) => {
    if (score >= 9) return 'Fortress';
    if (score >= 7) return 'Strong';
    if (score >= 5) return 'Building';
    return 'Emerging';
  };

  function renderPatents() {
    const moatValue = moatFilter.value;
    const velocityValue = velocityFilter.value;
    const sortValue = sortSelect.value;

    let filtered = PATENT_INTEL.filter(p => {
      if (moatValue === 'high' && p.ipMoatScore < 8) return false;
      if (moatValue === 'medium' && (p.ipMoatScore < 6 || p.ipMoatScore >= 8)) return false;
      if (moatValue === 'building' && p.ipMoatScore > 5) return false;
      if (velocityValue !== 'all' && p.velocityTrend !== velocityValue) return false;
      return true;
    });

    // Sort
    if (sortValue === 'moat') {
      filtered.sort((a, b) => b.ipMoatScore - a.ipMoatScore);
    } else if (sortValue === 'velocity') {
      const velOrder = { 'accelerating': 3, 'steady': 2, 'slowing': 1 };
      filtered.sort((a, b) => (velOrder[b.velocityTrend] || 0) - (velOrder[a.velocityTrend] || 0));
    } else {
      filtered.sort((a, b) => b.totalPatents - a.totalPatents);
    }

    patentGrid.innerHTML = '';

    filtered.forEach(patent => {
      const moatColor = getMoatColor(patent.ipMoatScore);
      const moatLabel = getMoatLabel(patent.ipMoatScore);
      const velColor = patent.velocityTrend === 'accelerating' ? '#22c55e' : '#6b7280';
      const velIcon = patent.velocityTrend === 'accelerating' ? 'üöÄ' : '‚Üí';

      const card = document.createElement('div');
      card.style.cssText = 'background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;transition:all 0.2s;';
      card.onmouseenter = () => card.style.borderColor = moatColor;
      card.onmouseleave = () => card.style.borderColor = 'var(--border)';

      card.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <div>
            <div style="font-size:18px;font-weight:700;color:var(--text);">${patent.company}</div>
            <div style="font-size:12px;color:${velColor};">${velIcon} ${patent.velocityTrend} (${patent.velocity})</div>
          </div>
          <div style="text-align:right;">
            <div style="font-size:28px;font-weight:800;color:${moatColor};">${patent.ipMoatScore}</div>
            <div style="font-size:10px;color:var(--text-m);text-transform:uppercase;">${moatLabel} Moat</div>
          </div>
        </div>

        <div style="display:grid;grid-template-columns:repeat(2,1fr);gap:12px;padding:16px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin-bottom:16px;">
          <div style="text-align:center;">
            <div style="font-size:24px;font-weight:800;color:var(--accent);">${patent.totalPatents.toLocaleString()}</div>
            <div style="font-size:11px;color:var(--text-m);">Total Patents</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:24px;font-weight:800;color:#3b82f6;">${patent.velocity}</div>
            <div style="font-size:11px;color:var(--text-m);">Annual Velocity</div>
          </div>
        </div>

        <div style="margin-bottom:16px;">
          <div style="font-size:11px;color:var(--text-m);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">üî¨ Technology Areas</div>
          <div style="display:flex;flex-wrap:wrap;gap:6px;">
            ${patent.techAreas.map(t => `<span style="font-size:11px;padding:4px 10px;background:rgba(255,107,44,0.1);color:var(--accent);border-radius:4px;font-weight:500;">${t}</span>`).join('')}
          </div>
        </div>

        ${patent.notablePatents && patent.notablePatents.length > 0 ? `
          <div style="margin-bottom:16px;">
            <div style="font-size:11px;color:var(--text-m);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">üìÑ Notable Patents</div>
            <ul style="font-size:12px;color:var(--text-s);margin:0;padding-left:16px;line-height:1.6;">
              ${patent.notablePatents.slice(0, 2).map(p => `<li>${p}</li>`).join('')}
            </ul>
          </div>
        ` : ''}

        ${patent.note ? `
          <div style="font-size:11px;color:var(--text-m);line-height:1.5;padding:12px;background:rgba(255,255,255,0.02);border-radius:8px;border-left:3px solid ${moatColor};">
            üí° ${patent.note.slice(0, 200)}${patent.note.length > 200 ? '...' : ''}
          </div>
        ` : ''}
      `;

      patentGrid.appendChild(card);
    });

    if (filtered.length === 0) {
      patentGrid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-m);grid-column:1/-1;">No patents match your filters.</div>';
    }
  }

  // Event listeners
  moatFilter.addEventListener('change', renderPatents);
  velocityFilter.addEventListener('change', renderPatents);
  sortSelect.addEventListener('change', renderPatents);

  renderPatents();
})();

// ‚îÄ‚îÄ‚îÄ 13. GOVERNMENT OPPORTUNITY TRACKER (ENHANCED) ‚îÄ‚îÄ‚îÄ
(function() {
  if (typeof GOV_DEMAND_TRACKER === 'undefined') return;

  const grid = document.getElementById('gov-tracker-grid');
  const statsBanner = document.getElementById('gov-stats-banner');
  const agencyFilter = document.getElementById('gov-agency-filter');
  const typeFilter = document.getElementById('gov-type-filter');
  const priorityFilter = document.getElementById('gov-priority-filter');

  const agencyColors = {
    'Defense Innovation Unit (DIU)': '#FF6B2C', 'DIU': '#FF6B2C',
    'DARPA': '#8b5cf6', 'NASA': '#3b82f6',
    'Department of Energy (DOE)': '#22c55e', 'DOE': '#22c55e',
    'AFWERX / Air Force': '#60a5fa', 'Air Force': '#60a5fa',
    'Navy': '#0ea5e9', 'Army': '#84cc16',
    'DHS': '#f59e0b', 'Space Force': '#a855f7'
  };

  const priorityColors = { 'Critical': '#ef4444', 'High': '#f59e0b', 'Medium': '#22c55e' };

  // Build stats
  const totalValue = GOV_DEMAND_TRACKER.reduce((sum, o) => {
    const val = o.value?.match(/\$?(\d+)/);
    return sum + (val ? parseInt(val[1]) : 0);
  }, 0);
  const criticalCount = GOV_DEMAND_TRACKER.filter(o => o.priority === 'Critical').length;
  const agencies = [...new Set(GOV_DEMAND_TRACKER.map(o => o.agency))];
  const types = [...new Set(GOV_DEMAND_TRACKER.map(o => o.type))];

  statsBanner.innerHTML = `
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:var(--accent);">${GOV_DEMAND_TRACKER.length}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Open Opportunities</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:#22c55e;">$${totalValue}M+</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Total Value</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:#ef4444;">${criticalCount}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Critical Priority</div>
    </div>
    <div style="background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:20px;text-align:center;">
      <div style="font-family:'Space Grotesk',sans-serif;font-size:32px;font-weight:800;color:#3b82f6;">${agencies.length}</div>
      <div style="font-size:12px;color:var(--text-m);text-transform:uppercase;letter-spacing:1px;">Agencies</div>
    </div>
  `;

  // Populate filters
  agencies.forEach(a => {
    const opt = document.createElement('option');
    opt.value = a;
    opt.textContent = a;
    agencyFilter.appendChild(opt);
  });
  types.forEach(t => {
    const opt = document.createElement('option');
    opt.value = t;
    opt.textContent = t;
    typeFilter.appendChild(opt);
  });

  function renderOpportunities() {
    const agency = agencyFilter.value;
    const type = typeFilter.value;
    const priority = priorityFilter.value;

    let filtered = GOV_DEMAND_TRACKER.filter(opp => {
      if (agency !== 'all' && opp.agency !== agency) return false;
      if (type !== 'all' && opp.type !== type) return false;
      if (priority !== 'all' && opp.priority !== priority) return false;
      return true;
    });

    grid.innerHTML = '';

    filtered.forEach(opp => {
      const color = agencyColors[opp.agency] || '#f59e0b';
      const pColor = priorityColors[opp.priority] || '#6b7280';
      const companies = opp.relevantCompanies || [];

      const card = document.createElement('div');
      card.style.cssText = 'background:var(--bg-card);border:1px solid var(--border);border-radius:12px;padding:24px;transition:all 0.2s;';
      card.onmouseenter = () => card.style.borderColor = 'var(--accent)';
      card.onmouseleave = () => card.style.borderColor = 'var(--border)';

      card.innerHTML = `
        <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:16px;">
          <span style="font-size:12px;padding:4px 12px;background:${color}22;color:${color};border-radius:4px;font-weight:600;">${opp.agency}</span>
          <span style="font-size:11px;padding:4px 10px;background:${pColor}22;color:${pColor};border-radius:12px;font-weight:600;">${opp.priority}</span>
        </div>
        <div style="font-size:17px;font-weight:700;color:var(--text);margin-bottom:10px;line-height:1.3;">${opp.title}</div>
        <div style="font-size:13px;color:var(--text-s);margin-bottom:16px;line-height:1.5;">${opp.description?.slice(0, 200) || 'Government opportunity'}...</div>

        <div style="display:grid;grid-template-columns:repeat(3,1fr);gap:12px;padding:16px 0;border-top:1px solid var(--border);border-bottom:1px solid var(--border);margin-bottom:16px;">
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text-m);margin-bottom:4px;">TYPE</div>
            <div style="font-size:12px;font-weight:600;color:var(--text);">${opp.type}</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text-m);margin-bottom:4px;">VALUE</div>
            <div style="font-size:12px;font-weight:600;color:#22c55e;">${opp.value || 'TBD'}</div>
          </div>
          <div style="text-align:center;">
            <div style="font-size:11px;color:var(--text-m);margin-bottom:4px;">DEADLINE</div>
            <div style="font-size:12px;font-weight:600;color:${opp.deadline === 'Rolling' ? '#3b82f6' : '#ef4444'};">${opp.deadline || 'Open'}</div>
          </div>
        </div>

        ${companies.length > 0 ? `
          <div style="margin-bottom:16px;">
            <div style="font-size:11px;color:var(--text-m);margin-bottom:8px;text-transform:uppercase;letter-spacing:1px;">üéØ Matched Companies</div>
            <div style="display:flex;flex-wrap:wrap;gap:8px;">
              ${companies.map(c => `<a href="index.html#companies" style="font-size:12px;padding:4px 10px;background:rgba(255,107,44,0.1);color:var(--accent);border-radius:4px;text-decoration:none;font-weight:500;">${c}</a>`).join('')}
            </div>
          </div>
        ` : ''}

        <div style="display:flex;gap:12px;">
          <a href="${opp.source || '#'}" target="_blank" style="flex:1;padding:10px;background:var(--accent);color:#000;border-radius:8px;text-align:center;text-decoration:none;font-weight:600;font-size:13px;">View Opportunity ‚Üí</a>
        </div>
      `;
      grid.appendChild(card);
    });

    if (filtered.length === 0) {
      grid.innerHTML = '<div style="text-align:center;padding:40px;color:var(--text-m);">No opportunities match your filters.</div>';
    }
  }

  // Event listeners
  agencyFilter.addEventListener('change', renderOpportunities);
  typeFilter.addEventListener('change', renderOpportunities);
  priorityFilter.addEventListener('change', renderOpportunities);

  renderOpportunities();

  // Last updated
  document.getElementById('gov-last-updated').textContent = 'Data refreshed daily from SAM.gov, SBIR.gov, and agency portals';
})();

// ‚îÄ‚îÄ‚îÄ SCROLL ANIMATIONS ‚îÄ‚îÄ‚îÄ
const obs = new IntersectionObserver(entries => {
  entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible'); });
}, { threshold:0.1 });
document.querySelectorAll('.animate-in').forEach(el => obs.observe(el));

// ‚îÄ‚îÄ‚îÄ SMOOTH SCROLL ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('a[href^="#"]').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    const t = document.querySelector(a.getAttribute('href'));
    if(t) t.scrollIntoView({ behavior:'smooth', block:'start' });
  });
});
</script>
</body>
</html>
