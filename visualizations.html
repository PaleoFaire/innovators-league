<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Innovation Insights | The Innovators League</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700;800;900&family=Space+Grotesk:wght@400;500;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    <script src="https://unpkg.com/leaflet.heat@0.2.0/dist/leaflet-heat.js"></script>
    <style>
*, *::before, *::after { margin:0; padding:0; box-sizing:border-box; }

:root {
  --bg: #000000;
  --bg-s: #0a0a0a;
  --bg-t: #111111;
  --bg-card: #0d0d0d;
  --text: #f0f0fa;
  --text-s: rgba(240,240,250,0.60);
  --text-m: rgba(240,240,250,0.40);
  --border: rgba(255,255,255,0.08);
  --border-hover: rgba(255,255,255,0.15);
  --accent: #FF6B2C;
  --accent-dim: rgba(255,107,44,0.12);
  --radius: 12px;
  --shadow: 0 1px 3px rgba(0,0,0,0.3);
  --shadow-md: 0 4px 12px rgba(0,0,0,0.4);
}

html { scroll-behavior: smooth; }
body { font-family:'Inter',-apple-system,sans-serif; background:var(--bg); color:var(--text); -webkit-font-smoothing:antialiased; }

/* Nav */
.nav { position:fixed; top:0; left:0; right:0; z-index:1000; display:flex; align-items:center; justify-content:space-between; padding:0 32px; height:56px; background:rgba(0,0,0,0.85); backdrop-filter:blur(16px); border-bottom:1px solid var(--border); }
.nav-brand { display:flex; align-items:center; gap:10px; }
.nav-logo { font-family:'Space Grotesk',sans-serif; font-weight:700; font-size:14px; color:#000; background:var(--accent); padding:3px 8px; border-radius:4px; letter-spacing:1px; }
.nav-title { font-family:'Space Grotesk',sans-serif; font-weight:600; font-size:13px; letter-spacing:2px; color:var(--text); }
.nav-links { display:flex; gap:24px; align-items:center; }
.nav-links a { font-size:14px; font-weight:500; color:var(--text-s); text-decoration:none; transition:color .15s; }
.nav-links a:hover { color:var(--text); }
.nav-cta { background:var(--accent)!important; color:#000!important; padding:6px 16px; border-radius:6px; font-weight:600!important; font-size:13px!important; }
.nav-cta:hover { opacity:0.9; }

/* Hero */
.hero { padding:100px 24px 48px; text-align:center; border-bottom:1px solid var(--border); position:relative; }
.hero::before { content:''; position:absolute; top:50%; left:50%; width:600px; height:600px; transform:translate(-50%,-50%); background:radial-gradient(ellipse,rgba(255,107,44,0.04) 0%,transparent 70%); pointer-events:none; }
.hero h1 { font-family:'Space Grotesk',sans-serif; font-size:clamp(32px,4vw,48px); font-weight:800; margin-bottom:8px; letter-spacing:-0.03em; }
.hero p { font-size:17px; color:var(--text-s); max-width:600px; margin:0 auto; }

/* Container */
.container { max-width:1200px; margin:0 auto; padding:0 24px; }

/* Section */
.viz-section { padding:64px 0; border-bottom:1px solid var(--border); }
.viz-section:last-of-type { border-bottom:none; }
.viz-header { margin-bottom:32px; }
.viz-header h2 { font-family:'Space Grotesk',sans-serif; font-size:24px; font-weight:700; margin-bottom:4px; letter-spacing:-0.02em; }
.viz-header p { font-size:14px; color:var(--text-m); }
.section-eyebrow { font-size:11px; font-weight:600; letter-spacing:3px; text-transform:uppercase; color:var(--accent); margin-bottom:8px; }

/* Stat Cards Row */
.stat-row { display:grid; grid-template-columns:repeat(auto-fit,minmax(180px,1fr)); gap:16px; margin-bottom:48px; }
.stat-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:24px; text-align:center; transition:border-color .2s; }
.stat-card:hover { border-color:var(--border-hover); }
.stat-card .num { font-family:'Space Grotesk',sans-serif; font-size:36px; font-weight:800; line-height:1; }
.stat-card .label { font-size:12px; color:var(--text-m); text-transform:uppercase; letter-spacing:1.5px; margin-top:6px; font-weight:500; }

/* Heatmap */
#heatmap { width:100%; height:550px; border-radius:var(--radius); border:1px solid var(--border); overflow:hidden; }

/* Bar Charts */
.bar-chart { display:flex; flex-direction:column; gap:8px; }
.bar-row { display:flex; align-items:center; gap:12px; }
.bar-label { width:180px; font-size:13px; font-weight:500; text-align:right; flex-shrink:0; white-space:nowrap; overflow:hidden; text-overflow:ellipsis; color:var(--text-s); }
.bar-track { flex:1; height:32px; background:var(--bg-t); border-radius:6px; overflow:hidden; position:relative; }
.bar-fill { height:100%; border-radius:6px; transition:width 1s cubic-bezier(.4,0,.2,1); display:flex; align-items:center; padding-left:10px; }
.bar-fill span { font-size:12px; font-weight:700; color:#fff; white-space:nowrap; }
.bar-count { width:36px; font-size:13px; font-weight:600; color:var(--text-s); text-align:left; flex-shrink:0; }

/* Treemap */
.treemap { display:grid; gap:4px; min-height:400px; }
.treemap-cell { border-radius:8px; padding:16px; display:flex; flex-direction:column; justify-content:space-between; cursor:pointer; transition:opacity .15s, transform .15s; position:relative; overflow:hidden; }
.treemap-cell:hover { opacity:0.9; transform:scale(1.01); }
.treemap-cell .cell-icon { font-size:24px; }
.treemap-cell .cell-name { font-size:14px; font-weight:700; color:#fff; }
.treemap-cell .cell-count { font-size:12px; color:rgba(255,255,255,0.8); }
.treemap-cell .cell-pct { position:absolute; top:12px; right:14px; font-size:20px; font-weight:800; color:rgba(255,255,255,0.25); }

/* Bubble Grid (Valuations) */
.bubble-grid { display:flex; flex-wrap:wrap; gap:12px; align-items:flex-end; justify-content:center; padding:20px 0; }
.bubble { border-radius:50%; display:flex; align-items:center; justify-content:center; flex-direction:column; text-align:center; transition:transform .2s; cursor:default; border:2px solid rgba(255,255,255,0.15); }
.bubble:hover { transform:scale(1.08); border-color:var(--accent); }
.bubble .b-name { font-size:10px; font-weight:700; color:#fff; line-height:1.2; padding:0 4px; }
.bubble .b-val { font-size:9px; color:rgba(255,255,255,0.8); }

/* Funding Pipeline */
.pipeline { display:flex; gap:2px; align-items:stretch; min-height:300px; }
.pipeline-col { flex:1; display:flex; flex-direction:column; align-items:center; }
.pipeline-bar { width:100%; border-radius:8px 8px 0 0; display:flex; align-items:flex-end; justify-content:center; padding-bottom:12px; transition:height 1s cubic-bezier(.4,0,.2,1); }
.pipeline-bar span { font-size:20px; font-weight:800; color:#fff; }
.pipeline-label { padding:12px 4px; text-align:center; }
.pipeline-label .p-stage { font-size:11px; font-weight:600; color:var(--text); }
.pipeline-label .p-count { font-size:10px; color:var(--text-m); margin-top:2px; }

/* City Grid */
.city-grid { display:grid; grid-template-columns:repeat(auto-fill,minmax(200px,1fr)); gap:12px; }
.city-card { background:var(--bg-card); border:1px solid var(--border); border-radius:var(--radius); padding:16px 20px; display:flex; align-items:center; gap:14px; transition:border-color .15s, box-shadow .15s; }
.city-card:hover { border-color:var(--border-hover); box-shadow:var(--shadow-md); }
.city-rank { font-family:'Space Grotesk',sans-serif; font-size:24px; font-weight:800; color:var(--text-m); width:32px; text-align:center; }
.city-card:nth-child(1) .city-rank { color:var(--accent); }
.city-card:nth-child(2) .city-rank { color:#60a5fa; }
.city-card:nth-child(3) .city-rank { color:#8b5cf6; }
.city-info .city-name { font-size:14px; font-weight:600; color:var(--text); }
.city-info .city-count { font-size:12px; color:var(--text-m); }

/* Footer */
.footer { background:var(--bg-s); border-top:1px solid var(--border); color:#fff; padding:32px 0; text-align:center; }
.footer p { font-size:13px; color:var(--text-m); }
.footer a { color:var(--text-s); text-decoration:none; }
.footer a:hover { color:var(--accent); }

/* Two column layout */
.two-col { display:grid; grid-template-columns:1fr 1fr; gap:32px; }

/* Dark Leaflet overrides */
.leaflet-container { background:#0a0a0a !important; }
.leaflet-control-zoom a { background:rgba(20,20,20,0.9)!important; color:var(--text)!important; border-color:var(--border)!important; }
.leaflet-control-zoom a:hover { background:rgba(30,30,30,0.95)!important; }
.leaflet-control-attribution { background:rgba(0,0,0,0.7)!important; color:var(--text-m)!important; }
.leaflet-control-attribution a { color:var(--text-s)!important; }
.leaflet-popup-content-wrapper { background:var(--bg-t)!important; color:var(--text)!important; border-radius:8px!important; box-shadow:var(--shadow-md)!important; }
.leaflet-popup-tip { background:var(--bg-t)!important; }

/* Responsive */
/* Mobile menu & auth nav */
.mobile-menu-btn { display:none; flex-direction:column; gap:5px; background:none; border:none; cursor:pointer; padding:4px; }
.mobile-menu-btn span { display:block; width:20px; height:2px; background:var(--text); transition:transform .3s, opacity .3s; }
.mobile-menu-btn.open span:nth-child(1) { transform:rotate(45deg) translate(5px,5px); }
.mobile-menu-btn.open span:nth-child(2) { opacity:0; }
.mobile-menu-btn.open span:nth-child(3) { transform:rotate(-45deg) translate(5px,-5px); }
.nav-auth { display:flex; align-items:center; gap:8px; }
.nav-sign-in-btn { background:none; border:1px solid rgba(255,255,255,0.2); color:var(--text); padding:6px 14px; border-radius:6px; font-size:13px; font-weight:500; cursor:pointer; transition:border-color .2s; }
.nav-sign-in-btn:hover { border-color:var(--accent); }
.nav-signout-btn { background:none; border:1px solid rgba(255,255,255,0.15); color:var(--text-s); padding:4px 12px; border-radius:4px; font-size:12px; cursor:pointer; }
.nav-user { display:flex; align-items:center; gap:8px; }
.nav-user-email { color:var(--text-s); font-size:12px; }
.nav-links.open { display:flex!important; flex-direction:column; position:absolute; top:56px; left:0; right:0; background:rgba(0,0,0,0.95); padding:16px; gap:12px; border-bottom:1px solid var(--border); }

@media(max-width:768px) {
  .nav { padding:0 16px; }
  .nav-links { display:none; }
  .mobile-menu-btn { display:flex; }
  .hero { padding:80px 16px 40px; }
  .stat-row { grid-template-columns:repeat(2,1fr); }
  .two-col { grid-template-columns:1fr; }
  .bar-label { width:120px; font-size:11px; }
  .pipeline { flex-wrap:wrap; }
  .pipeline-col { min-width:60px; }
}

/* Scrollbar */
::-webkit-scrollbar { width:8px; height:8px; }
::-webkit-scrollbar-track { background:transparent; }
::-webkit-scrollbar-thumb { background:rgba(255,255,255,0.15); border-radius:4px; }
::-webkit-scrollbar-thumb:hover { background:rgba(255,255,255,0.25); }

/* Animate in */
.animate-in { opacity:0; transform:translateY(16px); transition:opacity .6s ease, transform .6s ease; }
.animate-in.visible { opacity:1; transform:translateY(0); }
    </style>
</head>
<body>

<nav class="nav">
    <div class="nav-brand">
        <div class="nav-logo">ROS</div>
        <span class="nav-title">THE INNOVATORS LEAGUE</span>
    </div>
    <div class="nav-links">
        <a href="index.html#discovery-hub" class="nav-link">üó∫Ô∏è Map</a>
        <a href="index.html#companies" class="nav-link">üìä Database</a>
        <a href="index.html#innovator50" class="nav-link">üèÜ ROS 50</a>
        <a href="visualizations.html" class="nav-link active">üìà Insights</a>
        <a href="investors.html" class="nav-link">üí∞ Investors</a>
        <a href="jobs.html" class="nav-link">üíº Jobs</a>
        <div class="nav-auth" id="nav-auth">
            <button class="nav-sign-in-btn" onclick="TILAuth.showAuthModal()">Sign In</button>
            <a href="https://www.rationaloptimistsociety.com" target="_blank" rel="noopener" class="nav-cta">Join ROS</a>
        </div>
        <div class="nav-user" id="nav-user" style="display:none;">
            <span class="nav-user-email" id="nav-user-email"></span>
            <button class="nav-signout-btn" onclick="TILAuth.signOut()">Sign Out</button>
        </div>
    </div>
    <button class="mobile-menu-btn" aria-label="Menu">
        <span></span><span></span><span></span>
    </button>
</nav>

<header class="hero">
    <p class="section-eyebrow">RATIONAL OPTIMIST SOCIETY</p>
    <h1>Innovation Insights</h1>
    <p id="hero-subtitle">Interactive data visualizations from The Innovators League &mdash; loading...</p>
</header>

<!-- Key Stats -->
<section class="viz-section">
    <div class="container">
        <div class="stat-row" id="stat-row"></div>
    </div>
</section>

<!-- 1. Innovation Hotspots Heatmap -->
<section class="viz-section" id="hotspots">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">GEOGRAPHY</p>
            <h2>Innovation Hotspots</h2>
            <p>Where the world's most ambitious startups cluster. Brighter = more companies.</p>
        </div>
        <div id="heatmap" class="animate-in"></div>
    </div>
</section>

<!-- 2. Sector Treemap -->
<section class="viz-section" id="sectors">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">SECTORS</p>
            <h2>Sectors of Disruption</h2>
            <p id="sectors-subtitle">What these companies are building, by category.</p>
        </div>
        <div class="treemap animate-in" id="treemap"></div>
    </div>
</section>

<!-- 3. Top Cities + Country Bar Chart -->
<section class="viz-section" id="cities">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">LOCATIONS</p>
            <h2>Global Innovation Capitals</h2>
            <p>The cities and countries where the future is being built.</p>
        </div>
        <div class="two-col">
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">Top Cities</h3>
                <div class="city-grid" id="city-grid"></div>
            </div>
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">Companies by Country</h3>
                <div class="bar-chart" id="country-bars"></div>
            </div>
        </div>
    </div>
</section>

<!-- 4. Funding Pipeline -->
<section class="viz-section" id="funding">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">CAPITAL</p>
            <h2>The Funding Pipeline</h2>
            <p>From seed to public markets &mdash; how these companies are funded.</p>
        </div>
        <div class="pipeline animate-in" id="pipeline"></div>
    </div>
</section>

<!-- 5. Valuation Bubbles -->
<section class="viz-section" id="valuations">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">VALUATIONS</p>
            <h2>The Billion-Dollar Map</h2>
            <p>Every company with a known valuation, sized by market cap.</p>
        </div>
        <div class="bubble-grid animate-in" id="bubble-grid"></div>
    </div>
</section>

<!-- 6. US Deep Dive (still interesting with global data) -->
<section class="viz-section" id="us-deep-dive" style="background:var(--bg-s);">
    <div class="container">
        <div class="viz-header animate-in">
            <p class="section-eyebrow">DEEP DIVE</p>
            <h2>The California Dominance</h2>
            <p id="california-subtitle">California companies loading...</p>
        </div>
        <div class="two-col">
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">LA's Defense Tech Corridor</h3>
                <div class="bar-chart" id="la-bars"></div>
                <p style="font-size:12px;color:var(--text-m);margin-top:12px;">El Segundo, Torrance, and Hawthorne house dozens of companies &mdash; the new defense tech heartland.</p>
            </div>
            <div class="animate-in">
                <h3 style="font-size:16px;font-weight:700;margin-bottom:16px;font-family:'Space Grotesk',sans-serif;color:var(--text);">CA Sectors</h3>
                <div class="bar-chart" id="ca-sector-bars"></div>
            </div>
        </div>
    </div>
</section>


<footer class="footer">
    <div class="container">
        <p>&copy; 2026 <a href="https://www.rationaloptimistsociety.com" target="_blank">Rational Optimist Society</a> &middot; <a href="index.html">Back to Database</a></p>
    </div>
</footer>

<script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
<script src="auth.js?v=20260217b"></script>
<script src="data.js?v=20260217"></script>
<script>
// ‚îÄ‚îÄ‚îÄ MOBILE MENU ‚îÄ‚îÄ‚îÄ
(function() {
  const btn = document.querySelector('.mobile-menu-btn');
  const links = document.querySelector('.nav-links');
  if (btn && links) {
    btn.addEventListener('click', () => {
      links.classList.toggle('open');
      btn.classList.toggle('open');
    });
  }
})();

// ‚îÄ‚îÄ‚îÄ COUNTRY HELPER (matches app.js logic) ‚îÄ‚îÄ‚îÄ
const INTL_CODES_VIZ = {
  'UK':'United Kingdom','GB':'United Kingdom','FR':'France','SE':'Sweden','FI':'Finland',
  'CH':'Switzerland','DK':'Denmark','NO':'Norway','NL':'Netherlands','ES':'Spain',
  'IT':'Italy','EE':'Estonia','PL':'Poland','JP':'Japan','KR':'South Korea',
  'AU':'Australia','SG':'Singapore','NZ':'New Zealand','ZA':'South Africa','BR':'Brazil',
  'IE':'Ireland','CA-CAN':'Canada','PT':'Portugal','CZ':'Czech Republic'
};
const LOC_COUNTRIES = {'Germany':'Germany','Israel':'Israel','India':'India','Argentina':'Argentina','Ireland':'Ireland'};

function getCountryViz(stateCode, location) {
  if (INTL_CODES_VIZ[stateCode]) return INTL_CODES_VIZ[stateCode];
  if (location) {
    for (const [kw, country] of Object.entries(LOC_COUNTRIES)) {
      if (location.includes(kw)) return country;
    }
  }
  return 'United States';
}

// ‚îÄ‚îÄ‚îÄ HELPERS ‚îÄ‚îÄ‚îÄ
function parseVal(str) {
  if (!str) return 0;
  str = str.replace(/[^0-9.BMK+$T]/g,'');
  let num = parseFloat(str.replace(/[^0-9.]/g,'')) || 0;
  if (str.includes('T')) num *= 1000;
  else if (str.includes('B')) num *= 1;
  else if (str.includes('M')) num /= 1000;
  else if (str.includes('K')) num /= 1000000;
  return num;
}

const sectorColors = {};
Object.entries(SECTORS).forEach(([name, info]) => { sectorColors[name] = info.color; });

// ‚îÄ‚îÄ‚îÄ 0. KEY STATS ‚îÄ‚îÄ‚îÄ
(function() {
  const total = COMPANIES.length;
  const sectorCount = Object.keys(SECTORS).length;
  const countries = new Set(COMPANIES.map(c => getCountryViz(c.state, c.location)));
  const countryCount = countries.size;
  const cities = new Set(COMPANIES.map(c => c.location)).size;
  const caCount = COMPANIES.filter(c => c.state === 'CA').length;
  const withVal = COMPANIES.filter(c => c.valuation).length;

  const stats = [
    { num: total, label: 'Companies Tracked', color: 'var(--accent)' },
    { num: sectorCount, label: 'Sectors', color: '#3b82f6' },
    { num: countryCount, label: 'Countries', color: '#8b5cf6' },
    { num: cities, label: 'Cities', color: '#6366f1' },
    { num: caCount, label: 'Based in California', color: '#22c55e' },
    { num: withVal, label: 'With Valuations', color: '#f59e0b' }
  ];

  const row = document.getElementById('stat-row');
  stats.forEach(s => {
    const card = document.createElement('div');
    card.className = 'stat-card';
    card.innerHTML = `<div class="num" style="color:${s.color}">${s.num}</div><div class="label">${s.label}</div>`;
    row.appendChild(card);
  });

  document.getElementById('hero-subtitle').innerHTML =
    `Interactive data visualizations from The Innovators League &mdash; ${total} companies across ${countryCount} countries reshaping the world.`;
  document.getElementById('sectors-subtitle').textContent =
    `What these ${total} companies are building, by category.`;
  const caPct = Math.round(caCount / total * 100);
  document.getElementById('california-subtitle').textContent =
    `${caCount} of ${total} companies (${caPct}%) are based in California. Here's where they are.`;
})();

// ‚îÄ‚îÄ‚îÄ 1. HEATMAP (global, dark tiles) ‚îÄ‚îÄ‚îÄ
(function() {
  const map = L.map('heatmap', { center:[25,0], zoom:2, minZoom:2, maxZoom:12, scrollWheelZoom:true, zoomControl:true });
  L.tileLayer('https://{s}.basemaps.cartocdn.com/dark_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; OpenStreetMap &copy; CARTO', maxZoom:19
  }).addTo(map);

  const heatData = COMPANIES.filter(c => c.lat && c.lng).map(c => [c.lat, c.lng, 0.7]);
  L.heatLayer(heatData, { radius:28, blur:20, maxZoom:10, max:1.0,
    gradient: { 0.2:'rgba(255,107,44,0.15)', 0.4:'rgba(255,107,44,0.3)', 0.6:'#FF6B2C', 0.8:'#FF8147', 1.0:'#FF9560' }
  }).addTo(map);

  COMPANIES.forEach(c => {
    if (!c.lat || !c.lng) return;
    const color = sectorColors[c.sector] || '#6b7280';
    L.circleMarker([c.lat, c.lng], { radius:5, fillColor:color, color:'rgba(255,255,255,0.3)', weight:1, fillOpacity:0.9 })
      .bindPopup(`<strong>${c.name}</strong><br><span style="color:${color}">${c.sector}</span><br><small>${c.location}</small>`)
      .addTo(map);
  });
})();

// ‚îÄ‚îÄ‚îÄ 2. TREEMAP ‚îÄ‚îÄ‚îÄ
(function() {
  const counts = {};
  COMPANIES.forEach(c => { counts[c.sector] = (counts[c.sector]||0)+1; });
  const sorted = Object.entries(counts).sort((a,b) => b[1]-a[1]);
  const total = COMPANIES.length;

  const grid = document.getElementById('treemap');
  const rows = [];
  let row = [];
  let rowTotal = 0;
  const targetPerRow = total / 3;

  sorted.forEach(([sector, count]) => {
    row.push({ sector, count });
    rowTotal += count;
    if (rowTotal >= targetPerRow && rows.length < 2) {
      rows.push([...row]);
      row = [];
      rowTotal = 0;
    }
  });
  if (row.length) rows.push(row);

  grid.style.gridTemplateRows = rows.map(r => {
    const rowSum = r.reduce((a,b) => a+b.count, 0);
    return `${Math.max(rowSum/total*100, 20)}fr`;
  }).join(' ');

  rows.forEach(r => {
    const rowDiv = document.createElement('div');
    rowDiv.style.display = 'grid';
    rowDiv.style.gridTemplateColumns = r.map(s => `${s.count}fr`).join(' ');
    rowDiv.style.gap = '4px';

    r.forEach(({ sector, count }) => {
      const info = SECTORS[sector] || { color: '#6b7280', icon: 'üì¶' };
      const pct = Math.round(count/total*100);
      const cell = document.createElement('div');
      cell.className = 'treemap-cell';
      cell.style.background = info.color;
      cell.innerHTML = `
        <div><div class="cell-icon">${info.icon}</div><div class="cell-name">${sector}</div></div>
        <div class="cell-count">${count} companies</div>
        <div class="cell-pct">${pct}%</div>
      `;
      cell.addEventListener('click', () => { window.location.href = `index.html?sector=${encodeURIComponent(sector)}#companies`; });
      rowDiv.appendChild(cell);
    });

    grid.appendChild(rowDiv);
  });
})();

// ‚îÄ‚îÄ‚îÄ 3. CITIES + COUNTRY BARS ‚îÄ‚îÄ‚îÄ
(function() {
  // Cities
  const cityCounts = {};
  COMPANIES.forEach(c => { cityCounts[c.location] = (cityCounts[c.location]||0)+1; });
  const topCities = Object.entries(cityCounts).sort((a,b) => b[1]-a[1]).slice(0,12);

  const cityGrid = document.getElementById('city-grid');
  topCities.forEach(([city, count], i) => {
    const card = document.createElement('div');
    card.className = 'city-card';
    card.innerHTML = `
      <div class="city-rank">${i+1}</div>
      <div class="city-info"><div class="city-name">${city}</div><div class="city-count">${count} ${count===1?'company':'companies'}</div></div>
    `;
    cityGrid.appendChild(card);
  });

  // Countries instead of states
  const countryCounts = {};
  COMPANIES.forEach(c => {
    const country = getCountryViz(c.state, c.location);
    countryCounts[country] = (countryCounts[country]||0)+1;
  });
  const topCountries = Object.entries(countryCounts).sort((a,b) => b[1]-a[1]);
  const maxCountry = topCountries[0][1];

  const countryColors = {
    'United States':'#FF6B2C', 'United Kingdom':'#3b82f6', 'Germany':'#dc2626',
    'France':'#6366f1', 'Israel':'#f59e0b', 'Japan':'#ec4899', 'Canada':'#22c55e',
    'Sweden':'#14b8a6', 'Finland':'#60a5fa', 'Switzerland':'#f97316', 'India':'#8b5cf6',
    'South Korea':'#06b6d4', 'Australia':'#a855f7'
  };
  const countryBars = document.getElementById('country-bars');

  topCountries.forEach(([country, count]) => {
    const pct = (count/maxCountry*100);
    const color = countryColors[country] || '#6b7280';
    const row = document.createElement('div');
    row.className = 'bar-row';
    row.innerHTML = `
      <div class="bar-label">${country}</div>
      <div class="bar-track"><div class="bar-fill" style="width:0;background:${color}"><span>${count}</span></div></div>
    `;
    countryBars.appendChild(row);
    setTimeout(() => { row.querySelector('.bar-fill').style.width = pct + '%'; }, 300);
  });
})();

// ‚îÄ‚îÄ‚îÄ 4. FUNDING PIPELINE ‚îÄ‚îÄ‚îÄ
(function() {
  const stageCounts = {};
  COMPANIES.forEach(c => { if(c.fundingStage) stageCounts[c.fundingStage] = (stageCounts[c.fundingStage]||0)+1; });

  const simplified = [
    { label:'Seed', stages:['Seed','Early Stage'], color:'rgba(223,241,64,0.4)' },
    { label:'Series A', stages:['Series A'], color:'rgba(223,241,64,0.5)' },
    { label:'Series B', stages:['Series B'], color:'rgba(223,241,64,0.6)' },
    { label:'Series C', stages:['Series C'], color:'rgba(223,241,64,0.75)' },
    { label:'Series D+', stages:['Series D','Series E','Series F','Series G'], color:'#FF6B2C' },
    { label:'Late Stage', stages:['Late Stage','Private'], color:'#FF8147' },
    { label:'Public', stages:['Public','Alphabet subsidiary'], color:'#FF9560' }
  ];

  simplified.forEach(s => {
    s.count = s.stages.reduce((a,st) => a + (stageCounts[st]||0), 0);
  });

  const maxCount = Math.max(...simplified.map(s => s.count));
  const pipeline = document.getElementById('pipeline');

  simplified.forEach(s => {
    const pct = (s.count/maxCount*100);
    const col = document.createElement('div');
    col.className = 'pipeline-col';
    col.innerHTML = `
      <div class="pipeline-bar" style="height:0;background:${s.color}"><span>${s.count}</span></div>
      <div class="pipeline-label"><div class="p-stage">${s.label}</div><div class="p-count">${s.count} companies</div></div>
    `;
    pipeline.appendChild(col);
    setTimeout(() => { col.querySelector('.pipeline-bar').style.height = Math.max(pct, 8) + '%'; }, 500);
  });
})();

// ‚îÄ‚îÄ‚îÄ 5. VALUATION BUBBLES ‚îÄ‚îÄ‚îÄ
(function() {
  const valued = COMPANIES.filter(c => c.valuation && c.valuation.includes('$')).map(c => ({
    name: c.name, sector: c.sector, val: c.valuation, num: parseVal(c.valuation)
  })).sort((a,b) => b.num - a.num);

  const grid = document.getElementById('bubble-grid');
  if (!valued.length) return;
  const maxVal = valued[0].num;

  valued.forEach(v => {
    const size = Math.max(Math.sqrt(v.num / maxVal) * 160, 56);
    const color = sectorColors[v.sector] || '#6b7280';
    const bubble = document.createElement('div');
    bubble.className = 'bubble';
    bubble.style.width = size + 'px';
    bubble.style.height = size + 'px';
    bubble.style.background = color;
    bubble.title = `${v.name}: ${v.val}`;
    if (size > 70) {
      bubble.innerHTML = `<div class="b-name">${v.name}</div><div class="b-val">${v.val}</div>`;
    } else {
      bubble.innerHTML = `<div class="b-name" style="font-size:8px">${v.name}</div>`;
    }
    grid.appendChild(bubble);
  });
})();

// ‚îÄ‚îÄ‚îÄ 6. CALIFORNIA DEEP DIVE ‚îÄ‚îÄ‚îÄ
(function() {
  const laCorridorCities = ['El Segundo, CA','Torrance, CA','Hawthorne, CA','Redondo Beach, CA','Playa Vista, CA','Gardena, CA','Chatsworth, CA','Culver City, CA','Long Beach, CA','Huntington Beach, CA','Costa Mesa, CA','Irvine, CA'];
  const laCounts = {};
  COMPANIES.forEach(c => { if (laCorridorCities.includes(c.location)) laCounts[c.location] = (laCounts[c.location]||0)+1; });
  const laTop = Object.entries(laCounts).sort((a,b) => b[1]-a[1]);
  const maxLA = laTop[0] ? laTop[0][1] : 1;

  const laBars = document.getElementById('la-bars');
  const laColors = ['#FF6B2C','#FF8147','#FF9560','#FFB088','#FFD0B5','#60a5fa','#3b82f6','#2563eb','#1d4ed8','#1e3a8a'];

  laTop.forEach(([city, count], i) => {
    const pct = (count/maxLA*100);
    const row = document.createElement('div');
    row.className = 'bar-row';
    row.innerHTML = `
      <div class="bar-label">${city.replace(', CA','')}</div>
      <div class="bar-track"><div class="bar-fill" style="width:0;background:${laColors[i]||'#6b7280'}"><span>${count}</span></div></div>
    `;
    laBars.appendChild(row);
    setTimeout(() => { row.querySelector('.bar-fill').style.width = pct+'%'; }, 400);
  });

  // CA sectors
  const caSectors = {};
  COMPANIES.filter(c => c.state === 'CA').forEach(c => { caSectors[c.sector] = (caSectors[c.sector]||0)+1; });
  const caTop = Object.entries(caSectors).sort((a,b) => b[1]-a[1]);
  const maxCAS = caTop[0] ? caTop[0][1] : 1;

  const caBars = document.getElementById('ca-sector-bars');
  caTop.forEach(([sector, count]) => {
    const pct = (count/maxCAS*100);
    const color = sectorColors[sector] || '#6b7280';
    const row = document.createElement('div');
    row.className = 'bar-row';
    row.innerHTML = `
      <div class="bar-label">${sector}</div>
      <div class="bar-track"><div class="bar-fill" style="width:0;background:${color}"><span>${count}</span></div></div>
    `;
    caBars.appendChild(row);
    setTimeout(() => { row.querySelector('.bar-fill').style.width = pct+'%'; }, 400);
  });
})();


// ‚îÄ‚îÄ‚îÄ SCROLL ANIMATIONS ‚îÄ‚îÄ‚îÄ
const obs = new IntersectionObserver(entries => {
  entries.forEach(e => { if(e.isIntersecting) e.target.classList.add('visible'); });
}, { threshold:0.1 });
document.querySelectorAll('.animate-in').forEach(el => obs.observe(el));

// ‚îÄ‚îÄ‚îÄ SMOOTH SCROLL ‚îÄ‚îÄ‚îÄ
document.querySelectorAll('a[href^="#"]').forEach(a => {
  a.addEventListener('click', e => {
    e.preventDefault();
    const t = document.querySelector(a.getAttribute('href'));
    if(t) t.scrollIntoView({ behavior:'smooth', block:'start' });
  });
});
</script>
</body>
</html>
